FROM jenkins/jenkins:lts-jdk17

USER root

# ğŸ§© é€‚é… Debian 13 (trixie) + è®¾ç½®å›½å†… apt æº (USTC) + Python + pip å›½å†…æº + Allure CLI
RUN set -eux; \
    # åˆ‡æ¢åˆ°ä¸­ç§‘å¤§æºï¼ˆæ”¯æŒ Debian 13ï¼‰
    if [ -f /etc/apt/sources.list ]; then \
        sed -i 's@deb.debian.org@mirrors.ustc.edu.cn@g; s@security.debian.org@mirrors.ustc.edu.cn@g' /etc/apt/sources.list; \
    elif [ -f /etc/apt/sources.list.d/debian.sources ]; then \
        sed -i -E 's|URIs: .*debian|URIs: http://mirrors.ustc.edu.cn/debian|g' /etc/apt/sources.list.d/debian.sources; \
    fi; \
    apt-get clean; \
    apt-get update; \
    # å®‰è£… Python3 + pip3 + curl + unzipï¼ˆAllure éœ€è¦ï¼‰
    apt-get install -y --no-install-recommends python3 python3-pip curl unzip; \
    # è®¾ç½® pip å›½å†…é•œåƒ
    pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple; \
    # å®‰è£… Python æµ‹è¯•ä¾èµ–
    pip3 install pytest requests allure-pytest pyyaml pytest-dependency pytest-base-url pytest-html pytest-metadata --break-system-packages; \
    # ğŸ§© å®‰è£… Allure Commandline (CLI)
    curl -o allure-2.29.0.zip -L https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.zip; \
    unzip allure-2.29.0.zip -d /opt/; \
    ln -s /opt/allure-2.29.0/bin/allure /usr/bin/allure; \
    rm -f allure-2.29.0.zip; \
    # æ¸…ç†ç¼“å­˜
    apt-get clean; \
    rm -rf /var/lib/apt/lists/*

# ä¿æŒ Jenkins å¯åŠ¨å‘½ä»¤
CMD ["/usr/bin/tini", "--", "/usr/local/bin/jenkins.sh"]
